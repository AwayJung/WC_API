<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="wc_api.dao.ChatDAO">
    <!-- 채팅방 생성 -->
    <insert id="createChatRoom" parameterType="wc_api.model.db.chat.ChatRoom">
        INSERT INTO chat_room (room_id, item_id, seller_id, buyer_id)
        VALUES (#{roomId}, #{itemId}, #{sellerId}, #{buyerId})
    </insert>

    <!-- 사용자의 채팅방 목록 조회 -->
    <select id="findRoomsByUserId" resultType="wc_api.model.db.chat.ChatRoom">
        SELECT cr.*
        FROM chat_room cr
                 INNER JOIN user u ON cr.seller_id = u.id OR cr.buyer_id = u.id
        WHERE u.id = #{userId}
        ORDER BY cr.created_at DESC
    </select>

    <!-- 메시지 저장 -->
    <insert id="insertMessage" parameterType="wc_api.model.db.chat.ChatMessage">
        INSERT INTO chat_message (message_id, room_id, sender, receiver, message, sent_time, is_read)
        VALUES (#{messageId}, #{roomId}, #{sender}, #{receiver}, #{message}, #{sentTime}, #{isRead})
    </insert>

    <!-- 채팅방 메시지 내용 조회 -->
    <select id="findMessagesByRoomId" resultType="wc_api.model.db.chat.ChatMessage">
        SELECT message_id, room_id, sender, receiver, sent_time, is_read
        FROM chat_message
        WHERE room_id = #{roomId}
        ORDER BY sent_time ASC
    </select>

    <!-- 읽음 상태 업데이트 -->
    <update id="updateMessagesReadStatus">
        UPDATE chat_message
        SET is_read = true
        WHERE room_id = #{roomId}
        AND receiver = #{userId}
        AND is_read = false
    </update>
</mapper>